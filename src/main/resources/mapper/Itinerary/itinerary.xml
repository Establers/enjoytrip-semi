<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.enjoytrip.itinerary.model.mapper.ItineraryMapper">

	<resultMap type="hashmap" id="itinerary">
		<result column="itinerary_id" property="itineraryId"/>
		<result column="user_id" property="userId"/>
		<result column="date" property="date"/>
		<result column="start_date" property="startDate"/>
		<result column="end_date" property="endDate"/>
		<result column="title" property="title"/>
		<result column="content" property="content"/>
		<result column="place_name" property="placeName"/>
		<result column="place_address" property="placeAddress"/>
		<result column="place_order" property="placeOrder"/>
		<result column="place_comment" property="placeComment"/>
		<result column="content" property="content"/>
		<result column="itinerary_reply_id" property="itineraryReplyId"/>
	</resultMap>
	
	<sql id="search">
		<if test="word != null and word != ''">
			<if test="key == 'title'">
				where title like concat('%', #{word}, '%')
			</if>
			
			<if test="key == 'content'">
				where content like concat('%', #{word}, '%')
			</if>
			
			<if test="key == 'userid'">
				where user_id = ${word}
			</if>
		</if>
	</sql>
	
	<insert id="writeItinerary" parameterType="ItineraryDetailDto">
		insert into itinerary_detail (itineraryId,orders,placeId,userId,date,startDate,endDate,title,content)
		values (#{itineraryId}, #{orders},  #{placeId}, #{userId}, now(),now(), now(),#{title},#{content})
	</insert>
	
	<select id="listItinerary" resultType="ItineraryDetailDto" parameterType="map">
		select * from itinerary_detail
		<include refid="search"></include>
		order by itinerary_id
		limit #{start}, #{listsize}
	</select>
	
	<select id="getTotalItineraryCount" parameterType="map" resultType="int">
		select count(itinerary_id)
		from itinerary_detail
		<include refid="search"></include>
	</select>
	
	<select id="selectOne" resultType="ItineraryDetailDto" parameterType="java.lang.Integer">
		select * from itinerary_detail
		where itinerary_id=#{itineraryId}
	</select>
	
	<select id="selectPlace" resultType="ItineraryPlaceDto" parameterType="java.lang.Integer">
		select * from itinerary_place
		where itinerary_id=#{itineraryId}
	</select>
	
	<delete id="deleteItinerary" parameterType="java.lang.Integer">
		delete from itinerary_detail
		where itinerary_id=#{itineraryId}
	</delete>
	
	<update id="modifyItinerary" parameterType="ItineraryDetailDto">
		update itinerary_detail 
		set title=#{title}, content=#{content}, start_date=#{startDate}, end_date=#{endDate}
		where itinerary_id=#{itineraryId}
	</update>
	
	<insert id="registerplace" parameterType="ItineraryDetailDto">
		insert into itinerary_place (place_name, place_address, place_order, place_comment, itinerary_id)
		values
		<foreach collection="itineraryPlaces" item="itineraryPlace" separator=" , ">
			(default, #{itineraryPlace.placeName}, #{itineraryPlace.placeAddress}, placeOrder + 1, #{itineraryPlace.placeComment}, default)
		</foreach>
	</insert>
</mapper>