<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper
	namespace="com.enjoytrip.itinerary.model.mapper.ItineraryMapper">

	<resultMap id="ItineraryDetailResultMap"
		type="ItineraryDetailDto">
		<id property="itineraryId" column="itinerary_id" />
		<result property="userId" column="user_id" />
<<<<<<< HEAD
		<result property="date" column="date" />
=======
		<result property="registerDate" column="register_date" />
>>>>>>> 5a49b3d1972fd69e2482e3da4a37034ebe4ffa46
		<result property="startDate" column="start_date" />
		<result property="endDate" column="end_date" />
		<result property="title" column="title" />
		<result property="content" column="content" />
		<collection property="itineraryPlaces" ofType="ItineraryPlaceDto">
<<<<<<< HEAD
			<id property="placeName" column="place_name" />
			<result property="placeAddress" column="place_address" />
			<result property="placeOrder" column="place_order" />
			<result property="placeComment" column="place_comment" />
=======
			<result property="placeName" column="place_name" />
			<result property="placeAddress" column="place_address" />
			<result property="placeOrder" column="place_order" />
			<result property="placeComment" column="place_comment" />
			<result property="itineraryId" column="itinerary_id" />
			<result property="placeId" column="place_id" />
>>>>>>> 5a49b3d1972fd69e2482e3da4a37034ebe4ffa46
		</collection>
	</resultMap>

	<sql id="search">
		<if test="word != null and word != ''">
			<if test="key == 'title'">
				where title like concat('%', #{word}, '%')
			</if>

			<if test="key == 'content'">
				where content like concat('%', #{word}, '%')
			</if>

			<if test="key == 'userid'">
				where user_id = ${word}
			</if>
		</if>
	</sql>

<<<<<<< HEAD
	<insert id="writeItinerary" parameterType="ItineraryDetailDto">
		INSERT INTO itinerary_detail (user_id, date, start_date, end_date,
		title, content)
		VALUES (#{userId}, NOW(), #{startDate}, #{endDate},
		#{title}, #{content});

		<foreach collection="itineraryPlaces" item="place"
			index="index">
			INSERT INTO itinerary_place (place_name, place_address,
			place_order,
			place_comment, itinerary_id)
			SELECT #{place.placeName},
			#{place.placeAddress}, #{place.placeOrder},
			#{place.placeComment},
			LAST_INSERT_ID()
			FROM itinerary_detail
			WHERE user_id = #{userId} AND
			start_date = #{startDate} AND end_date =
			#{endDate} AND title =
			#{title} AND content = #{content};
		</foreach>
	</insert>

	<select id="listItinerary" resultType="ItineraryDetailDto"
		parameterType="map">
		select * from itinerary_detail
=======
	<insert id="writeItinerary" parameterType="ItineraryDetailDto" useGeneratedKeys="true" keyProperty="itineraryId">
	  INSERT INTO itinerary_detail (user_id, register_date, start_date, end_date, title, content)
	  VALUES ( #{userId}, NOW(), #{startDate}, #{endDate}, #{title}, #{content});
	</insert>
	
	<insert id="writePlace" parameterType="ItineraryPlaceDto">
	    INSERT INTO itinerary_place (place_name, place_address, place_order, place_comment, itinerary_id) 
	    VALUES (#{placeName}, #{placeAddress}, #{placeOrder}, #{placeComment}, #{itineraryId})
	</insert>

	<select id="listItinerary" resultMap="ItineraryDetailResultMap" parameterType="map">
		select d.itineary_id, d.user_id, DATE_FORMAT(d.register_date, '%Y-%m-%d %H:%i:%s') as 'register_date', 
			d.start_date, d.end_date, d.title, d.content, u.nickname
		from itinerary_detail d left join user u using(user_id)
>>>>>>> 5a49b3d1972fd69e2482e3da4a37034ebe4ffa46
		<include refid="search"></include>
		order by itinerary_id
		limit #{start}, #{listsize}
	</select>

	<select id="getTotalItineraryCount" parameterType="map"
		resultType="int">
		select count(itinerary_id)
		from itinerary_detail
		<include refid="search"></include>
	</select>

	<select id="selectOne" resultMap="ItineraryDetailResultMap"
		parameterType="java.lang.Integer">
<<<<<<< HEAD
		SELECT d.itinerary_id, d.user_id, d.date, d.start_date,
		d.end_date, d.title,
		d.content,
		p.place_name, p.place_address,
		p.place_order, p.place_comment
=======
		SELECT d.itinerary_id, d.user_id, d.register_date, d.start_date,
		d.end_date, d.title,
		d.content,
		p.place_name, p.place_address,
		p.place_order, p.place_comment, p.place_id
>>>>>>> 5a49b3d1972fd69e2482e3da4a37034ebe4ffa46
		FROM itinerary_detail d
		LEFT JOIN
		itinerary_place p ON d.itinerary_id = p.itinerary_id
		WHERE
		d.itinerary_id = #{itineraryId}
		order by p.place_order
	</select>

	<delete id="deleteItinerary" parameterType="java.lang.Integer">
		delete from
		itinerary_detail
		where itinerary_id=#{itineraryId}
	</delete>

	<update id="modifyItinerary" parameterType="ItineraryDetailDto">
		UPDATE itinerary_detail
<<<<<<< HEAD
		SET title = #{title}, content = #{content},
		start_date = #{startDate},
		end_date = #{endDate}
		WHERE itinerary_id =
		#{itineraryId};

		<foreach collection="itineraryPlaces" item="place"
			index="index">
			UPDATE itinerary_place
			SET place_name = #{place.placeName},
			place_address =
			#{place.placeAddress},
			place_order =
			#{place.placeOrder}, place_comment = #{place.placeComment}
			WHERE
			itinerary_id = #{itineraryId} AND place_name = #{place.placeName};
		</foreach>
	</update>


=======
		SET title = #{title}, content = #{content}, start_date = #{startDate},end_date = #{endDate}
		WHERE itinerary_id = #{itineraryId};

	</update>
	<update id="modifyPlace" parameterType="ItineraryPlaceDto">
		UPDATE itinerary_place
		SET place_name = #{placeName}, place_address = #{placeAddress}, place_order = #{placeOrder}, place_comment = #{placeComment}
		WHERE itinerary_id = #{itineraryId} AND place_id = #{placeId};
	</update>
>>>>>>> 5a49b3d1972fd69e2482e3da4a37034ebe4ffa46
</mapper>